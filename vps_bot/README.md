# üñ•Ô∏è VPS Shop Telegram Bot

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Telegram-–±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–¥–∞–∂–∏ VPS —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–∞ –±–∞–∑–µ Proxmox.

**–°—Ç–µ–∫:** Python 3.13 ‚Ä¢ aiogram 3 ‚Ä¢ FastAPI ‚Ä¢ PostgreSQL ‚Ä¢ Redis ‚Ä¢ Docker Compose ‚Ä¢ Caddy ‚Ä¢ n8n

---

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –°–∫–∞—á–∞–π –ø—Ä–æ–µ–∫—Ç
git clone https://github.com/YOUR/vps-shop-bot
cd vps-shop-bot

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏ Docker
curl -fsSL https://get.docker.com | sh

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏ make
apt install make -y

# 4. –ù–∞—Å—Ç—Ä–æ–π –∫–æ–Ω—Ñ–∏–≥
cp .env.example .env
nano .env   # –∑–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è

# 5. –°–æ–∑–¥–∞–π –ø–∞–ø–∫–∏
mkdir -p logs data/backups
chmod 755 logs data

# 6. –ó–∞–ø—É—Å—Ç–∏
make up

# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
make logs
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
vps-shop-bot/
‚îú‚îÄ‚îÄ main.py                    # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ docker-compose.yml         # –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã
‚îú‚îÄ‚îÄ Makefile                   # –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ .env.example               # –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥–∞
‚îú‚îÄ‚îÄ caddy/
‚îÇ   ‚îî‚îÄ‚îÄ Caddyfile              # HTTPS + security headers
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py          # –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ + —Ç–∞—Ä–∏—Ñ—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bot.py             # –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py        # SQLAlchemy async
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis.py           # Redis –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ webhook.py         # FastAPI webhook —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scheduler.py       # APScheduler (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∏–µ)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.py          # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ models/                # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ repositories/          # –°–ª–æ–π —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ proxmox.py         # Proxmox API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vps_provision.py   # –°–æ–∑–¥–∞–Ω–∏–µ/–ø—Ä–æ–¥–ª–µ–Ω–∏–µ VPS
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ n8n.py             # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ n8n
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.py        # –ë–∞–Ω, –ø—Ä–æ–≤–µ—Ä–∫–∞ —é–∑–µ—Ä–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rate_limit.py      # Rate limiting —á–µ—Ä–µ–∑ Redis
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logging.py         # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client/            # –•–µ–Ω–¥–ª–µ—Ä—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payments/          # CryptoBot, YooKassa
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin/             # –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.py          # /health —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhooks.py        # Payment webhooks
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ keyboards.py       # –í—Å–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ       ‚îî‚îÄ‚îÄ admin.py           # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä @admin_only
‚îî‚îÄ‚îÄ logs/                      # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ (.env)

### 1. Telegram Bot
```
BOT_TOKEN=         # @BotFather ‚Üí /newbot
ADMIN_IDS=         # @userinfobot ‚Üí —Ç–≤–æ–π ID
BOT_RUN_MODE=polling  # polling –¥–ª—è —Ç–µ—Å—Ç–∞, webhook –¥–ª—è –ø—Ä–æ–¥–∞
```

### 2. Proxmox
```
PROXMOX_HOST=https://IP_–°–ï–†–í–ï–†–ê:8006
PROXMOX_TOKEN_NAME=bot
PROXMOX_TOKEN_VALUE=  # Proxmox ‚Üí Datacenter ‚Üí API Tokens ‚Üí Add
PROXMOX_GATEWAY=      # Hetzner Robot ‚Üí —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä ‚Üí IPs ‚Üí —à–ª—é–∑
PROXMOX_IP_POOL=      # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ IP —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
```

### 3. –ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
```
CRYPTOBOT_ENABLED=true
CRYPTOBOT_TOKEN=   # @CryptoBot ‚Üí /pay ‚Üí –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

YUKASSA_ENABLED=true
YUKASSA_SHOP_ID=   # yookassa.ru ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí API
YUKASSA_SECRET_KEY=
```

### 4. n8n
```
N8N_WEBHOOK_URL=   # URL –≤–µ–±—Ö—É–∫–∞ –≤ n8n –≤–æ—Ä–∫—Ñ–ª–æ—É
N8N_API_KEY=       # –∫–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
N8N_DOMAIN=        # –¥–æ–º–µ–Ω n8n –ø–∞–Ω–µ–ª–∏
```

### 5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```
WEBHOOK_SECRET_TOKEN=  # openssl rand -hex 32
API_SECRET_TOKEN=      # openssl rand -hex 32
REDIS_PASSWORD=        # –ø—Ä–∏–¥—É–º–∞–π —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å
```

---

## üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–º–µ–Ω–∞ (Caddy)

1. –ù–∞–ø—Ä–∞–≤—å DNS A-–∑–∞–ø–∏—Å—å –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞:
   - `bot.example.com` ‚Üí IP —Å–µ—Ä–≤–µ—Ä–∞
   - `n8n.example.com` ‚Üí IP —Å–µ—Ä–≤–µ—Ä–∞

2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π `caddy/Caddyfile` ‚Äî –∑–∞–º–µ–Ω–∏ `bot.example.com` –∏ `n8n.example.com` –Ω–∞ —Å–≤–æ–∏ –¥–æ–º–µ–Ω—ã

3. Caddy —Å–∞–º –ø–æ–ª—É—á–∏—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –æ—Ç Let's Encrypt

---

## ü§ñ n8n ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

n8n –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `https://n8n.example.com`

### –°–æ–±—ã—Ç–∏—è –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ n8n:
| –°–æ–±—ã—Ç–∏–µ | –ö–æ–≥–¥–∞ | –î–∞–Ω–Ω—ã–µ |
|---------|-------|--------|
| `vps.created` | –ö—É–ø–ª–µ–Ω –Ω–æ–≤—ã–π VPS | telegram_id, ip, tariff, vmid |
| `vps.renewed` | –ü—Ä–æ–¥–ª—ë–Ω VPS | telegram_id, ip, tariff, expires_at |
| `vps.expired` | –£–¥–∞–ª—ë–Ω –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏—é | telegram_id, ip, tariff |
| `payment.received` | –ü–æ–ª—É—á–µ–Ω –ø–ª–∞—Ç—ë–∂ | telegram_id, amount, currency |
| `user.registered` | –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | telegram_id |

### –ü—Ä–∏–º–µ—Ä—ã –≤–æ—Ä–∫—Ñ–ª–æ—É –≤ n8n:
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram-–∫–∞–Ω–∞–ª** –ø—Ä–∏ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π –ø–æ–∫—É–ø–∫–µ
- **–ó–∞–ø–∏—Å—å –≤ Google Sheets** –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- **–ê–ª–µ—Ä—Ç –≤ Telegram** –µ—Å–ª–∏ VPS –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è (–æ—à–∏–±–∫–∞)
- **–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç** –ø–æ –≤—ã—Ä—É—á–∫–µ –Ω–∞ email
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–æ—Ä–∫—Ñ–ª–æ—É –≤ n8n:
1. –û—Ç–∫—Ä–æ–π n8n ‚Üí New Workflow
2. –î–æ–±–∞–≤—å –Ω–æ–¥—É **Webhook** (–º–µ—Ç–æ–¥ POST)
3. –°–∫–æ–ø–∏—Ä—É–π URL –≤–∏–¥–∞ `https://n8n.example.com/webhook/vps-events`
4. –î–æ–±–∞–≤—å –≤ `.env`: `N8N_WEBHOOK_URL=<URL –∏–∑ —à–∞–≥–∞ 3>`
5. –î–æ–±–∞–≤—å –Ω—É–∂–Ω—ã–µ –Ω–æ–¥—ã –ø–æ—Å–ª–µ Webhook (Telegram, Sheets, Email –∏ —Ç.–¥.)

---

## üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

| –£—Ä–æ–≤–µ–Ω—å | –ß—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç |
|---------|-------------|
| **Rate Limiting** | –ù–µ –±–æ–ª–µ–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω –Ω–∞ —é–∑–µ—Ä–∞ (Redis) |
| **Ban —Å–∏—Å—Ç–µ–º–∞** | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î |
| **Webhook Secret** | Telegram –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Å–µ–∫—Ä–µ—Ç–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º |
| **Payment Signature** | CryptoBot HMAC-SHA256 –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è |
| **Security Headers** | CSP, X-Frame-Options, X-Content-Type —á–µ—Ä–µ–∑ Caddy |
| **Non-root Docker** | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Ç –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **Network isolation** | –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π Docker —Å–µ—Ç–∏ |
| **Redis Auth** | –ü–∞—Ä–æ–ª—å –Ω–∞ Redis |

---

## üìã –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
make up           # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
make down         # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
make restart      # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
make logs         # –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
make build        # –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑
make shell        # –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
make db-shell     # PostgreSQL –∫–æ–Ω—Å–æ–ª—å
make backup       # –ë–µ–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
make status       # –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```

---

## üîß Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π webhook URL –≤ –ª–∏—á–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–∞—Ö:
- **CryptoBot**: `/pay` ‚Üí –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí `https://bot.example.com/cryptobot-webhook`
- **YooKassa**: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Üí `https://bot.example.com/yukassa-webhook`

---

## üìä –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ

–û—Ç–∫—Ä–æ–π `app/core/config.py`, –¥–æ–±–∞–≤—å –≤ `TARIFFS`:
```python
"ultra": {
    "name": "üî• –£–ª—å—Ç—Ä–∞",
    "cpu": 8,
    "ram": 8192,
    "disk": 160,
    "price_rub": 1600,
    "price_usdt": 18.0,
    "description": "8 vCPU ‚Ä¢ 8 GB RAM ‚Ä¢ 160 GB SSD",
    "emoji": "üî•",
},
```
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏: `make restart`

---

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|---------|---------|
| –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç | `make logs` ‚Üí –ø—Ä–æ–≤–µ—Ä—å BOT_TOKEN |
| VPS –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è | –ü—Ä–æ–≤–µ—Ä—å PROXMOX_HOST, TOKEN, IP –≤ –ø—É–ª–µ |
| –û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç | –ü—Ä–æ–≤–µ—Ä—å —Ç–æ–∫–µ–Ω—ã CryptoBot/YooKassa –∏ webhook URL |
| n8n –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è | –ü—Ä–æ–≤–µ—Ä—å N8N_WEBHOOK_URL –≤ .env |
| SSL –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –£–±–µ–¥–∏—Å—å —á—Ç–æ DNS —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞ |
