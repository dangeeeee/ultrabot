.PHONY: up down restart logs build shell db-shell redis-shell backup status migrate help

help:
	@echo ""
	@echo "  üñ•Ô∏è  VPS Shop Bot ‚Äî –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
	@echo ""
	@echo "  –ó–∞–ø—É—Å–∫:"
	@echo "    make up           –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã"
	@echo "    make down         –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã"
	@echo "    make restart      –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞"
	@echo "    make build        –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑"
	@echo ""
	@echo "  –õ–æ–≥–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:"
	@echo "    make logs         –õ–æ–≥–∏ –±–æ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
	@echo "    make status       –°—Ç–∞—Ç—É—Å –∏ —Ä–µ—Å—É—Ä—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
	@echo ""
	@echo "  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:"
	@echo "    make migrate      –ó–∞–ø—É—Å—Ç–∏—Ç—å Alembic –º–∏–≥—Ä–∞—Ü–∏–∏"
	@echo "    make db-shell     PostgreSQL –∫–æ–Ω—Å–æ–ª—å"
	@echo "    make backup       –°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø –ë–î"
	@echo ""
	@echo "  –û—Ç–ª–∞–¥–∫–∞:"
	@echo "    make shell        Bash –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–æ—Ç–∞"
	@echo "    make redis-shell  Redis CLI"
	@echo ""

up:
	@mkdir -p logs data/backups
	@chmod 755 logs data
	docker compose up -d
	@echo ""
	@echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!"
	@echo "   –ë–æ—Ç:  http://localhost:8080/health"
	@echo "   n8n:  https://$(shell grep N8N_DOMAIN .env 2>/dev/null | cut -d= -f2 || echo 'n8n.example.com')"
	@echo ""

down:
	docker compose down

restart:
	docker compose restart bot
	@echo "‚è≥ –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞..."
	@sleep 3
	docker compose logs --tail=20 bot

logs:
	docker compose logs -f bot

build:
	docker compose build bot
	docker compose up -d bot

shell:
	docker compose exec bot bash

db-shell:
	docker compose exec postgres psql -U $$(grep POSTGRES_USER .env | cut -d= -f2 || echo vpsbot) -d $$(grep POSTGRES_DB .env | cut -d= -f2 || echo vpsbot)

redis-shell:
	docker compose exec redis redis-cli -a $$(grep REDIS_PASSWORD .env | cut -d= -f2 || echo redispass)

migrate:
	docker compose exec bot python -m alembic upgrade head
	@echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

backup:
	@mkdir -p data/backups
	docker compose exec -T postgres pg_dump \
		-U $$(grep POSTGRES_USER .env | cut -d= -f2 || echo vpsbot) \
		$$(grep POSTGRES_DB .env | cut -d= -f2 || echo vpsbot) \
		> data/backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "‚úÖ –ë–µ–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ data/backups/"

status:
	@echo "=== –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã ==="
	docker compose ps
	@echo ""
	@echo "=== –†–µ—Å—É—Ä—Å—ã ==="
	docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
